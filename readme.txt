Цель: Стандартизировать выходные данные, чтобы одни и те же данные всегда попадали в один столбец. Для этого мы создаем библиотеку шаблонов, которые описывают структуру групп данных (группа — это блок из 3 строк и 8 столбцов, но может быть и другое количество строк, хотя пока мы фокусируемся на 3 строках).

Шаблон — это описание того, как данные из группы ячеек в исходной таблице должны быть извлечены и в какие столбцы результирующей таблицы они должны быть записаны.

Структура шаблона (в формате JSON):

id: уникальный идентификатор шаблона.

name: название шаблона для человека.

sheet: подстрока, которая должна содержаться в названии листа Excel, чтобы шаблон считался подходящим.

description: описание шаблона.

fingerprint: строка, уникально описывающая структуру группы. Формат: "{rowspan}x{colspan}_{row}_{col}_{required}|...", где required — это true или false в зависимости от наличия данных в ячейке при создании шаблона.

cells: массив ячеек, каждая из которых описывается:

row: строка относительно начала группы (0-индекс).

col: столбец относительно начала группы (0-индекс).

rowspan: количество строк, которые занимает ячейка (для объединенных ячеек).

colspan: количество столбцов, которые занимает ячейка (для объединенных ячеек).

required: наличие данных в ячейке (true — есть данные, false — пустая).

output_column: название столбца в результирующей таблице, куда будут записаны данные из этой ячейки.

Логика работы программы:

Программа анализирует каждый лист в Excel файлах.

На каждом листе она находит блоки (цепочки) и группы внутри этих блоков.

Для каждой группы (высотой 3 строки) программа определяет:

Координаты каждой ячейки (относительно начала группы).

Размеры ячеек (с учетом объединенных ячеек).

Наличие данных в каждой ячейке.

На основе этой информации генерируется fingerprint группы.

Программа ищет в библиотеке шаблонов шаблон, у которого поле sheet содержится в названии текущего листа и fingerprint совпадает с fingerprint группы.

Если шаблон найден, то данные из группы извлекаются согласно шаблону (значения из ячеек записываются в соответствующие столбцы, указанные в output_column).

Если шаблон не найден, то создается новый шаблон с fingerprint группы и названием листа (подстрока, по которой будет происходить сопоставление). В этом новом шаблоне поле output_column для каждой ячейки остается пустым (или с каким-то placeholder), и программа должна предложить пользователю вручную заполнить названия выходных столбцов. После заполнения шаблон сохраняется в библиотеку.

Важные моменты:

Шаблон привязан к листу (по подстроке в названии листа) и к структуре группы (через fingerprint).

fingerprint включает информацию о размерах ячеек и о наличии данных (required). Это позволяет различать шаблоны с одинаковой структурой, но разным заполнением (например, одни ячейки могут быть пустыми, а другие — нет).

Программа не использует приоритеты (match_priority), так как ищет точное совпадение по fingerprint и sheet.

При создании нового шаблона пользователь должен вручную назначить output_column для ячеек, которые он хочет извлекать. Ячейки, которые не должны попадать в выходную таблицу, можно оставить с пустым output_column (или, возможно, мы добавим флаг ignore).

Пример JSON с двумя шаблонами (уже приведен выше, но здесь он будет в полном виде с комментариями):

json
{
  "templates": [
    {
      "id": "template_522_001",
      "name": "Шаблон для листа 522 (тип А)",
      "sheet": "522",
      "description": "Группа 3×8, первая ячейка объединена 3×1",
      "fingerprint": "3x1_0_0_true|3x1_0_1_true|1x3_0_2_true|1x3_0_5_true|1x3_1_2_true|2x3_1_5_true|1x3_2_2_true",
      "cells": [
        {
          "row": 0,
          "col": 0,
          "rowspan": 3,
          "colspan": 1,
          "required": true,
          "output_column": "Керамика"
        },
        {
          "row": 0,
          "col": 1,
          "rowspan": 3,
          "colspan": 1,
          "required": true,
          "output_column": "Железо"
        },
        {
          "row": 0,
          "col": 2,
          "rowspan": 1,
          "colspan": 3,
          "required": true,
          "output_column": "Шихта"
        },
        {
          "row": 0,
          "col": 5,
          "rowspan": 1,
          "colspan": 3,
          "required": true,
          "output_column": "Блок 1"
        },
        {
          "row": 1,
          "col": 2,
          "rowspan": 1,
          "colspan": 3,
          "required": true,
          "output_column": "Плавка"
        },
        {
          "row": 1,
          "col": 5,
          "rowspan": 2,
          "colspan": 3,
          "required": true,
          "output_column": "Комментарий"
        },
        {
          "row": 2,
          "col": 2,
          "rowspan": 1,
          "colspan": 3,
          "required": true,
          "output_column": "Блок 2"
        }
      ]
    },
    {
      "id": "template_9002_001",
      "name": "Шаблон для листа 9002",
      "sheet": "9002",
      "description": "Группа 3×8, стандартная структура",
      "fingerprint": "3x1_0_0_true|3x1_0_1_true|1x3_0_2_true|1x3_0_5_true|1x3_1_2_true|2x3_1_5_true|1x3_2_2_true",
      "cells": [
        {
          "row": 0,
          "col": 0,
          "rowspan": 3,
          "colspan": 1,
          "required": true,
          "output_column": "Керамика"
        },
        {
          "row": 0,
          "col": 1,
          "rowspan": 3,
          "colspan": 1,
          "required": true,
          "output_column": "Железо"
        },
        {
          "row": 0,
          "col": 2,
          "rowspan": 1,
          "colspan": 3,
          "required": true,
          "output_column": "Шихта"
        },
        {
          "row": 0,
          "col": 5,
          "rowspan": 1,
          "colspan": 3,
          "required": true,
          "output_column": "Цифра"
        },
        {
          "row": 1,
          "col": 2,
          "rowspan": 1,
          "colspan": 3,
          "required": true,
          "output_column": "Плавка"
        },
        {
          "row": 1,
          "col": 5,
          "rowspan": 2,
          "colspan": 3,
          "required": true,
          "output_column": "Комментарий"
        },
        {
          "row": 2,
          "col": 2,
          "rowspan": 1,
          "colspan": 3,
          "required": true,
          "output_column": "Блок 1"
        }
      ]
    }
  ]
}
Процесс создания нового шаблона:

Программа обнаруживает группу, для которой нет шаблона (не совпадает fingerprint или sheet).

Создается новый объект шаблона с id, name (можно сгенерировать автоматически), sheet (подстрока из названия листа, возможно, нужно будет задать вручную или использовать целое название листа), description (по умолчанию пустое или сгенерированное), fingerprint (рассчитанный) и cells (с полями row, col, rowspan, colspan, required — на основе анализа группы, а output_column — пустые строки или null).

Этот шаблон добавляется в библиотеку (возможно, после подтверждения пользователем).

Пользователь должен для каждой ячейки, из которой нужно извлекать данные, указать output_column. Ячейки, которые не нужны, можно пометить как игнорируемые (например, оставить output_column пустым, и программа их не будет извлекать).

Дополнительные соображения:

В будущем можно добавить возможность редактирования шаблонов (изменение output_column, добавление/удаление ячеек).

Можно добавить возможность объединения нескольких ячеек в один выходной столбец (конкатенация) или другие преобразования данных, но пока это не требуется.

Валидация:

При загрузке шаблонов из JSON нужно проверять их корректность (уникальность id, соответствие fingerprint ячейкам, отсутствие конфликтов).